{% load static %}
{% load driver_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - Hospione</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Fonts and Icons -->
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'passenger/css/global.css' %}">

<style>
/* Ola-like Dashboard Styles - Preserving Existing Color Theme */
:root {
    --primary-teal: #00A59E;
    --primary-cyan: #0EB9D3;
}

body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Open Sans', sans-serif;
}

.driver-dashboard {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Top Navigation Bar */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.navbar-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.driver-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #00A59E;
    font-size: 18px;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.driver-info {
    display: flex;
    flex-direction: column;
}

.driver-name {
    color: white;
    font-weight: 600;
    font-size: 16px;
    margin: 0;
}

.driver-status-text {
    color: rgba(255, 255, 255, 0.9);
    font-size: 12px;
    margin: 0;
}

.navbar-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.wallet-info {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 8px 15px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: white;
    font-weight: 600;
    font-size: 14px;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.wallet-icon {
    font-size: 16px;
}

/* Toggle Switch - Using Existing Theme */
.toggle-container {
    position: relative;
    display: inline-block;
}

.toggle-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    pointer-events: none;
}

.toggle-label {
    position: relative;
    display: block;
    width: 64px;
    height: 32px;
    cursor: pointer;
}

.toggle-track {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 28px;
    height: 28px;
    background-color: white;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 1;
}

.toggle-input:checked + .toggle-label .toggle-track {
    background: rgba(255, 255, 255, 0.5);
}

.toggle-input:checked + .toggle-label .toggle-thumb {
    transform: translateX(32px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Map Container */
.map-container {
    position: fixed;
    top: 70px;
    left: 0;
    right: 0;
    bottom: 120px;
    background: #e5e7eb;
    overflow: hidden;
}

#driver-map {
    width: 100%;
    height: 100%;
    z-index: 1;
}

.map-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #6b7280;
    z-index: 1000;
    background: white;
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.map-loading i {
    font-size: 48px;
    margin-bottom: 10px;
    opacity: 0.5;
    color: #00A59E;
}

.location-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #dc2626;
    z-index: 1000;
    background: white;
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    max-width: 80%;
}

.location-error i {
    font-size: 48px;
    margin-bottom: 10px;
}

/* Custom Driver Marker Icon */
.driver-icon-div {
    background: transparent;
    border: none;
}

.driver-icon {
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    border-radius: 50%;
    border: 4px solid white;
    box-shadow: 0 4px 12px rgba(0, 165, 158, 0.4);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

/* Passenger Marker Icon */
.passenger-icon-div {
    background: transparent;
    border: none;
}

.passenger-marker-icon {
    background: #dc2626;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    border: 4px solid white;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.passenger-marker-icon i {
    transform: rotate(45deg);
}

/* Route Info Card */
.route-info-card {
    z-index: 1000;
}

/* Toast Animation */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Ride Request Notification Popup */
.ride-request-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.ride-request-overlay.show {
    display: flex;
}

.ride-request-popup {
    background: white;
    border-radius: 25px;
    padding: 25px;
    max-width: 90%;
    width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
    position: relative;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.popup-header {
    text-align: center;
    margin-bottom: 20px;
}

.countdown-timer {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    box-shadow: 0 4px 15px rgba(0, 165, 158, 0.3);
    color: white;
    font-size: 32px;
    font-weight: 700;
}

.countdown-text {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

.passenger-info-section {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px 0;
    border-bottom: 1px solid #e5e7eb;
}

.passenger-avatar-popup {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.passenger-details-popup {
    flex: 1;
}

.passenger-name-popup {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 5px 0;
}

.passenger-rating-popup {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #f59e0b;
    font-size: 14px;
    font-weight: 600;
}

.trip-details-section {
    padding: 20px 0;
}

.location-item-popup {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 15px;
}

.location-icon-popup {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.location-item-popup.pickup .location-icon-popup {
    background: #dcfce7;
    color: #16a34a;
}

.location-item-popup.dropoff .location-icon-popup {
    background: #fee2e2;
    color: #dc2626;
}

.location-info-popup {
    flex: 1;
}

.location-label-popup {
    font-size: 12px;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
    margin: 0 0 5px 0;
    letter-spacing: 0.5px;
}

.location-address-popup {
    font-size: 16px;
    color: #1f2937;
    font-weight: 600;
    margin: 0;
    line-height: 1.4;
}

.fare-section-popup {
    background: #f9fafb;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
}

.fare-item-popup {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e5e7eb;
}

.fare-item-popup:last-child {
    border-bottom: none;
}

.fare-label-popup {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
}

.fare-amount-popup {
    font-size: 24px;
    font-weight: 700;
    color: #00A59E;
}

.popup-actions {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.btn-popup {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: 15px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-popup-reject {
    background: white;
    color: #dc2626;
    border: 2px solid #dc2626;
}

.btn-popup-reject:hover {
    background: #fee2e2;
    transform: translateY(-2px);
}

.btn-popup-accept {
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    color: white;
}

.btn-popup-accept:hover {
    background: linear-gradient(135deg, #0EB9D3, #00A59E);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 165, 158, 0.3);
}

.timeout-message {
    text-align: center;
    padding: 20px;
    color: #dc2626;
    font-weight: 600;
    display: none;
}

.timeout-message.show {
    display: block;
}

/* Bottom Status Card */
.bottom-status-card {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 120px;
    background: white;
    border-top-left-radius: 25px;
    border-top-right-radius: 25px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    z-index: 999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #10b981;
    display: inline-block;
    margin-right: 8px;
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.status-message {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin: 10px 0;
    text-align: center;
}

.status-submessage {
    font-size: 14px;
    color: #6b7280;
    text-align: center;
    margin-top: 5px;
}

.status-unavailable {
    color: #6b7280;
}

.status-unavailable .status-indicator {
    background: #9ca3af;
    animation: none;
}

/* Quick Actions Menu (Hidden initially, can be toggled) */
.quick-actions {
    position: fixed;
    bottom: 140px;
    right: 20px;
    z-index: 998;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.action-button {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #00A59E;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-button:hover {
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    color: white;
    transform: scale(1.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .top-navbar {
        height: 60px;
        padding: 0 15px;
    }
    
    .driver-avatar {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .driver-name {
        font-size: 14px;
    }
    
    .driver-status-text {
        font-size: 11px;
    }
    
    .wallet-info {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .map-container {
        top: 60px;
        bottom: 100px;
    }
    
    .bottom-status-card {
        height: 100px;
        padding: 15px;
    }
    
    .status-message {
        font-size: 16px;
    }
    
    .status-submessage {
        font-size: 12px;
    }
}

/* Driver Arrived Button */
.driver-arrived-container {
    position: fixed;
    bottom: 140px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    animation: slideUpFade 0.3s ease-out;
}

.driver-arrived-btn {
    background: linear-gradient(135deg, #00A59E, #0EB9D3);
    color: white;
    border: none;
    padding: 16px 32px;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 165, 158, 0.4);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    min-width: 200px;
    justify-content: center;
}

.driver-arrived-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(0, 165, 158, 0.5);
    background: linear-gradient(135deg, #0EB9D3, #00A59E);
}

.driver-arrived-btn:active {
    transform: translateY(0);
}

.driver-arrived-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.driver-arrived-btn i {
    font-size: 18px;
}

@keyframes slideUpFade {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@media (max-width: 768px) {
    .driver-arrived-container {
        bottom: 120px;
        left: 20px;
        right: 20px;
        transform: none;
    }
    
    .driver-arrived-btn {
        width: 100%;
        min-width: auto;
    }
}

/* Menu Button */
.menu-button {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.menu-button:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Sidebar Menu (Hidden by default) */
.sidebar-menu {
    position: fixed;
    top: 70px;
    right: -300px;
    width: 300px;
    height: calc(100vh - 70px);
    background: white;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.sidebar-menu.open {
    right: 0;
}

.menu-item {
    padding: 15px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 15px;
    color: #1f2937;
    text-decoration: none;
    transition: all 0.3s ease;
}

.menu-item:hover {
    background: #f3f4f6;
    color: #00A59E;
}

.menu-item i {
    width: 20px;
    color: #00A59E;
}
</style>
</head>
<body>
<div class="driver-dashboard">
    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="navbar-left">
            <div class="driver-avatar">
                {{ driver.first_name|first }}{{ driver.last_name|first }}
      </div>
            <div class="driver-info">
                <p class="driver-name">{{ driver.first_name }} {{ driver.last_name }}</p>
                <p class="driver-status-text" id="availability-text">
                    {% if driver.availability %}Online{% else %}Offline{% endif %}
                </p>
    </div>
    </div>
        
        <div class="navbar-right">
            <div class="wallet-info">
                <i class="fas fa-wallet wallet-icon"></i>
                <span>₹{{ total_earnings|floatformat:0 }}</span>
    </div>
            
      <div class="toggle-container">
        <input type="checkbox" id="availability-toggle" class="toggle-input" {% if driver.availability %}checked{% endif %}>
        <label for="availability-toggle" class="toggle-label">
          <span class="toggle-track"></span>
          <span class="toggle-thumb"></span>
        </label>
      </div>
            
            <button class="menu-button" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Map Container -->
    <div class="map-container">
        <div id="driver-map"></div>
        <div id="map-loading" class="map-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <div>Loading map...</div>
        </div>
        <div id="location-error" class="location-error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <div>Location access denied. Please enable location services.</div>
    </div>
  </div>

    <!-- Bottom Status Card -->
    <div class="bottom-status-card" id="status-card">
        <div class="status-message" id="status-message">
            {% if driver.availability %}
                <span class="status-indicator"></span>
                You're Online
            {% else %}
                <span class="status-indicator"></span>
                You're Offline
            {% endif %}
    </div>
        <div class="status-submessage" id="status-submessage">
            {% if driver.availability %}
                Waiting for Ride Requests
            {% else %}
                Turn on availability to start receiving rides
            {% endif %}
    </div>
    </div>

    <!-- Driver Arrived Button (shown after ride acceptance) -->
    <div id="driver-arrived-button-container" class="driver-arrived-container" style="display: none;">
        <button id="driver-arrived-btn" class="driver-arrived-btn">
            <i class="fas fa-map-marker-alt"></i>
            <span>Driver Arrived</span>
        </button>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'driver:driver_rides' %}" class="action-button" title="My Rides">
            <i class="fas fa-list"></i>
        </a>
        <a href="{% url 'driver:driver_earnings' %}" class="action-button" title="Earnings">
            <i class="fas fa-rupee-sign"></i>
        </a>
        <a href="{% url 'driver:driver_profile' driver.driver_id %}" class="action-button" title="Profile">
            <i class="fas fa-user"></i>
        </a>
    </div>

    <!-- Sidebar Menu -->
    <div class="sidebar-menu" id="sidebar-menu">
        <a href="{% url 'driver_homepage' %}" class="menu-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{% url 'driver:driver_rides' %}" class="menu-item">
            <i class="fas fa-list"></i>
            <span>My Rides</span>
        </a>
        <a href="{% url 'driver:driver_ride_request' %}" class="menu-item">
            <i class="fas fa-bell"></i>
            <span>Ride Requests</span>
        </a>
        <a href="{% url 'driver:driver_earnings' %}" class="menu-item">
            <i class="fas fa-rupee-sign"></i>
            <span>Earnings</span>
        </a>
        <a href="{% url 'driver_rating_page' %}" class="menu-item">
            <i class="fas fa-star"></i>
            <span>Ratings</span>
        </a>
        <a href="{% url 'driver:driver_profile' driver.driver_id %}" class="menu-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
        <a href="{% url 'logout' %}" class="menu-item">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </div>
  </div>

<!-- Ride Request Notification Popup -->
<div id="ride-request-overlay" class="ride-request-overlay" onclick="if(event.target === this) closeRideRequest()">
    <div class="ride-request-popup" onclick="event.stopPropagation()">
        <div class="popup-header">
            <div class="countdown-timer" id="countdown-timer">120</div>
            <p class="countdown-text">New Ride Request</p>
    </div>

        <div class="passenger-info-section">
            <div class="passenger-avatar-popup">
                <i class="fas fa-user"></i>
    </div>
            <div class="passenger-details-popup">
                <h3 class="passenger-name-popup" id="popup-passenger-name">John Doe</h3>
                <div class="passenger-rating-popup">
                    <i class="fas fa-star"></i>
                    <span id="popup-passenger-rating">4.8</span>
    </div>
    </div>
  </div>

        <div class="trip-details-section">
            <div class="location-item-popup pickup">
                <div class="location-icon-popup">
                    <i class="fas fa-map-marker-alt"></i>
        </div>
                <div class="location-info-popup">
                    <p class="location-label-popup">Pickup</p>
                    <p class="location-address-popup" id="popup-pickup">123 Main Street, City</p>
      </div>
    </div>

            <div class="location-item-popup dropoff">
                <div class="location-icon-popup">
                    <i class="fas fa-flag-checkered"></i>
          </div>
                <div class="location-info-popup">
                    <p class="location-label-popup">Dropoff</p>
                    <p class="location-address-popup" id="popup-dropoff">456 Park Avenue, City</p>
          </div>
        </div>
      </div>

        <div class="fare-section-popup">
            <div class="fare-item-popup">
                <span class="fare-label-popup">Estimated Fare</span>
                <span class="fare-amount-popup" id="popup-fare">₹250</span>
          </div>
            <div class="fare-item-popup">
                <span class="fare-label-popup">Service Type</span>
                <span class="fare-label-popup" id="popup-service-type">Standard</span>
    </div>
  </div>

        <div class="timeout-message" id="timeout-message">
            <i class="fas fa-clock"></i>
            <p>Request timed out</p>
        </div>

        <div class="popup-actions" id="popup-actions">
            <button class="btn-popup btn-popup-reject" onclick="rejectRideRequest()">
                <i class="fas fa-times"></i>
                Reject
            </button>
            <button class="btn-popup btn-popup-accept" onclick="acceptRideRequest()">
                <i class="fas fa-check"></i>
                Accept
            </button>
      </div>
    </div>
  </div>

<!-- Leaflet.js JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Availability Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('availability-toggle');
      const statusText = document.getElementById('availability-text');
        const statusMessage = document.getElementById('status-message');
        const statusSubmessage = document.getElementById('status-submessage');
        const statusCard = document.getElementById('status-card');

      toggle.addEventListener('change', () => {
        const availability = toggle.checked;

        // Optimistic UI update
            updateStatusUI(availability);

        fetch("{% url 'driver:toggle_availability' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `availability=${availability}`
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
                    updateStatusUI(data.availability);
          } else {
            // Revert on failure
            toggle.checked = !availability;
                    updateStatusUI(!availability);
            alert("Failed to update availability. Please try again.");
          }
        })
        .catch(err => {
          console.error("Error updating availability:", err);
          // Revert on error
          toggle.checked = !availability;
                updateStatusUI(!availability);
          alert("Network error. Please check your connection and try again.");
        });
      });

        function updateStatusUI(isAvailable) {
            if (isAvailable) {
                statusText.textContent = "Online";
                statusMessage.innerHTML = '<span class="status-indicator"></span>You\'re Online';
                statusSubmessage.textContent = "Waiting for Ride Requests";
                statusCard.classList.remove('status-unavailable');
            } else {
                statusText.textContent = "Offline";
                statusMessage.innerHTML = '<span class="status-indicator"></span>You\'re Offline';
                statusSubmessage.textContent = "Turn on availability to start receiving rides";
                statusCard.classList.add('status-unavailable');
            }
        }
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar-menu');
        sidebar.classList.toggle('open');
    }

    // Close sidebar when clicking outside
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar-menu');
        const menuButton = document.querySelector('.menu-button');
        
        if (!sidebar.contains(e.target) && !menuButton.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    });
  </script>

<!-- Map and Ride Request Notification Script -->
<script>
    // Map and Location Tracking
    let map = null;
    let driverMarker = null;
    let watchId = null;
    let currentLat = null;
    let currentLng = null;

    // Ride Request Notification
    let notificationSound = null;
    let countdownInterval = null;
    let countdownTime = 120; // 120 seconds (2 minutes)
    let currentRideRequest = null;
    let processedRequestIds = new Set(); // Track which requests we've already shown
    
    // Map route and markers
    let passengerMarker = null;
    let routePolyline = null;
    let routeInfoCard = null;
    
    // Active booking tracking
    let currentBookingId = null;

    // Initialize Map
    function initMap() {
        // Try to get current location first
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    setupMap(currentLat, currentLng);
                    startLocationTracking();
                },
                (error) => {
                    console.error('Error getting location:', error);
                    // Default to a central location (e.g., Mumbai)
                    currentLat = 19.0760;
                    currentLng = 72.8777;
                    setupMap(currentLat, currentLng);
                    document.getElementById('location-error').style.display = 'block';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            // Fallback if geolocation not supported
            currentLat = 19.0760;
            currentLng = 72.8777;
            setupMap(currentLat, currentLng);
            document.getElementById('location-error').style.display = 'block';
        }
    }

    function setupMap(lat, lng) {
        // Hide loading message
        document.getElementById('map-loading').style.display = 'none';

        // Initialize map
        map = L.map('driver-map').setView([lat, lng], 15);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Create custom driver icon
        const driverIcon = L.divIcon({
            className: 'driver-icon-div',
            html: '<div class="driver-icon"><i class="fas fa-car"></i></div>',
            iconSize: [50, 50],
            iconAnchor: [25, 25]
        });

        // Add driver marker
        driverMarker = L.marker([lat, lng], { icon: driverIcon }).addTo(map);
    }

    function startLocationTracking() {
        if (!navigator.geolocation) {
            console.error('Geolocation not supported');
            return;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        };

        watchId = navigator.geolocation.watchPosition(
            (position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;

                if (driverMarker) {
                    // Smoothly move marker to new position
                    driverMarker.setLatLng([currentLat, currentLng]);
                    map.setView([currentLat, currentLng], map.getZoom(), { animate: true, duration: 1 });
                } else {
                    // Create marker if it doesn't exist
                    const driverIcon = L.divIcon({
                        className: 'driver-icon-div',
                        html: '<div class="driver-icon"><i class="fas fa-car"></i></div>',
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });
                    driverMarker = L.marker([currentLat, currentLng], { icon: driverIcon }).addTo(map);
                }

                // Hide error message if location is now available
                document.getElementById('location-error').style.display = 'none';
            },
            (error) => {
                console.error('Location tracking error:', error);
                if (error.code === error.PERMISSION_DENIED) {
                    document.getElementById('location-error').style.display = 'block';
                }
            },
            options
        );
    }

    // Geocode an address to get coordinates
    async function geocodeAddress(address) {
        if (!address) {
            throw new Error('No address provided');
        }
        
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
        console.log('Geocoding address:', address);
        
        try {
            const response = await fetch(url, {
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'DropMeDriverApp/1.0'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Geocoding failed: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error('No results found for address');
            }
            
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            
            if (isNaN(lat) || isNaN(lng)) {
                throw new Error('Invalid coordinates from geocoding');
            }
            
            console.log('Geocoded address:', address, '->', [lat, lng]);
            return { lat, lng, display_name: data[0].display_name };
        } catch (error) {
            console.error('Geocoding error:', error);
            throw error;
        }
    }

    // Calculate distance between two coordinates (Haversine formula) - moved up for use in validation
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Validate coordinates are reasonable for India region (rough bounds)
    function isValidIndiaCoordinate(lat, lng) {
        // India approximate bounds: lat 6.5-37, lng 68-97
        // But we'll be more lenient: lat 5-40, lng 65-100
        const isValid = lat >= 5 && lat <= 40 && lng >= 65 && lng <= 100;
        if (!isValid) {
            console.warn('Coordinate outside India region:', { lat, lng });
        }
        return isValid;
    }

    // Validate coordinates are reasonable (not in ocean, valid ranges)
    function areReasonableCoordinates(lat, lng) {
        // Basic global bounds
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            return false;
        }
        
        // For now, check if they're in reasonable range for India
        // If driver is in India, passenger should also be nearby
        if (currentLat && currentLng) {
            const driverLat = parseFloat(currentLat);
            const driverLng = parseFloat(currentLng);
            
            // If driver is in India region, passenger should be within reasonable distance
            if (isValidIndiaCoordinate(driverLat, driverLng)) {
                // Passenger should also be in India or nearby
                if (!isValidIndiaCoordinate(lat, lng)) {
                    // Check if distance is reasonable (not thousands of km)
                    const distance = calculateDistance(driverLat, driverLng, lat, lng);
                    if (distance > 500) { // More than 500km is suspicious for local rides
                        console.warn('Unusually large distance detected:', distance, 'km');
                        return false;
                    }
                }
            }
        }
        
        return true;
    }

    // Ride Request Notification Functions
    function createNotificationSound() {
        // Create a simple notification sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }

    function showRideRequest(rideData) {
        // Don't show if already processed
        if (processedRequestIds.has(rideData.id)) {
            return;
        }
        
        // Validate and parse coordinates
        const pickupLat = rideData.pickupLat !== null && rideData.pickupLat !== undefined ? parseFloat(rideData.pickupLat) : null;
        const pickupLng = rideData.pickupLng !== null && rideData.pickupLng !== undefined ? parseFloat(rideData.pickupLng) : null;
        
        // Log coordinate validation
        console.log('Ride request data received:', {
            id: rideData.id,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            pickupLatRaw: rideData.pickupLat,
            pickupLngRaw: rideData.pickupLng,
            pickup: rideData.pickup
        });
        
        // Validate coordinates are valid numbers
        if (isNaN(pickupLat) || isNaN(pickupLng) || pickupLat === null || pickupLng === null) {
            console.error('Invalid pickup coordinates:', { pickupLat, pickupLng });
        }
        
        // Store validated coordinates back in rideData
        rideData.pickupLat = pickupLat;
        rideData.pickupLng = pickupLng;
        
        currentRideRequest = rideData;
        countdownTime = 120; // Reset countdown to 120 seconds (2 minutes)

        // Update popup content
        document.getElementById('popup-passenger-name').textContent = rideData.passengerName || 'Passenger';
        document.getElementById('popup-passenger-rating').textContent = rideData.rating || '4.5';
        document.getElementById('popup-pickup').textContent = rideData.pickup || 'Pickup Location';
        document.getElementById('popup-dropoff').textContent = rideData.dropoff || 'Dropoff Location';
        document.getElementById('popup-fare').textContent = '₹' + (rideData.fare || '0');
        document.getElementById('popup-service-type').textContent = rideData.serviceType || 'Standard';

        // Show popup
        const overlay = document.getElementById('ride-request-overlay');
        overlay.classList.add('show');

        // Play sound
        createNotificationSound();

        // Start countdown
        startCountdown();

        // Show actions, hide timeout message
        document.getElementById('popup-actions').style.display = 'flex';
        document.getElementById('timeout-message').classList.remove('show');
        
        // Mark as processed
        processedRequestIds.add(rideData.id);
    }

    function startCountdown() {
        const timerElement = document.getElementById('countdown-timer');
        timerElement.textContent = countdownTime;

        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        countdownInterval = setInterval(() => {
            countdownTime--;
            timerElement.textContent = countdownTime;

            if (countdownTime <= 0) {
                clearInterval(countdownInterval);
                handleTimeout();
            }
        }, 1000);
    }

    function handleTimeout() {
        // Hide actions
        document.getElementById('popup-actions').style.display = 'none';
        
        // Show timeout message
        document.getElementById('timeout-message').classList.add('show');

        // Auto-close after 3 seconds
        setTimeout(() => {
            closeRideRequest();
        }, 3000);
    }

    function acceptRideRequest() {
        if (!currentRideRequest) {
            console.error('No current ride request to accept');
            return;
        }

        // Stop countdown
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        // Store ride data before closing popup
        const rideData = { ...currentRideRequest };
        
        // Validate and parse coordinates
        const pickupLat = rideData.pickupLat !== null && rideData.pickupLat !== undefined ? parseFloat(rideData.pickupLat) : null;
        const pickupLng = rideData.pickupLng !== null && rideData.pickupLng !== undefined ? parseFloat(rideData.pickupLng) : null;
        const driverLat = currentLat ? parseFloat(currentLat) : null;
        const driverLng = currentLng ? parseFloat(currentLng) : null;

        // Log coordinate validation
        console.log('Accepting ride request:', {
            rideId: rideData.id,
            driverCoords: driverLat && driverLng ? [driverLat, driverLng] : 'Not available',
            passengerCoords: pickupLat && pickupLng ? [pickupLat, pickupLng] : 'Not available',
            pickupAddress: rideData.pickup
        });

        // Close popup immediately for better UX
        closeRideRequest();

        // Function to get passenger coordinates with fallback to geocoding
        async function getPassengerCoordinates() {
            const pickupAddress = rideData.pickup;
            
            // First, try to use provided coordinates if they're valid
            if (pickupLat !== null && pickupLng !== null && !isNaN(pickupLat) && !isNaN(pickupLng)) {
                // Validate coordinates are reasonable
                if (areReasonableCoordinates(pickupLat, pickupLng)) {
                    console.log('Using provided coordinates:', [pickupLat, pickupLng]);
                    return [pickupLat, pickupLng];
                } else {
                    console.warn('Provided coordinates seem invalid/unreasonable, geocoding address instead');
                }
            }
            
            // If coordinates are invalid or missing, geocode the pickup address
            if (pickupAddress) {
                try {
                    console.log('Geocoding pickup address (coordinates invalid/missing):', pickupAddress);
                    const geocoded = await geocodeAddress(pickupAddress);
                    return [geocoded.lat, geocoded.lng];
                } catch (error) {
                    console.error('Geocoding failed:', error);
                    // Fall back to provided coordinates even if they seem wrong
                    if (pickupLat !== null && pickupLng !== null && !isNaN(pickupLat) && !isNaN(pickupLng)) {
                        console.warn('Using provided coordinates as last resort (may be incorrect):', [pickupLat, pickupLng]);
                        return [pickupLat, pickupLng];
                    }
                }
            }
            
            // Last resort: use mock coordinates near driver
            console.warn('No valid coordinates or address, using fallback');
            return null;
        }

        // Get passenger coordinates with geocoding fallback
        getPassengerCoordinates().then(passengerCoords => {
            if (!passengerCoords) {
                // No valid coordinates available
                console.error('Could not determine passenger pickup location');
                showToast('Unable to determine pickup location. Please try again.', 'error');
                return;
            }

            if (driverLat !== null && driverLng !== null && !isNaN(driverLat) && !isNaN(driverLng)) {
                console.log('Final coordinates for route:', {
                    driver: [driverLat, driverLng],
                    passenger: passengerCoords,
                    pickupAddress: rideData.pickup
                });
                
                // Draw route with validated coordinates
                drawRouteToPassenger(
                    [driverLat, driverLng],
                    passengerCoords,
                    rideData.pickup || 'Pickup Location'
                );
            } else {
                console.error('Driver coordinates not available');
                showToast('Driver location not available. Please enable location services.', 'error');
            }
        }).catch(error => {
            console.error('Error getting passenger coordinates:', error);
            showToast('Error determining pickup location', 'error');
        });

        // Send AJAX request to accept the ride (non-blocking)
        // Use relative URL to avoid CORS issues
        const acceptUrl = "{% url 'driver:accept_ride' 0 %}".replace('0', rideData.id);
        console.log('Sending accept request to:', acceptUrl);
        
        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrfToken = getCookie('csrftoken') || '{{ csrf_token }}';
        
        fetch(acceptUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `csrfmiddlewaretoken=${encodeURIComponent(csrfToken)}`,
            redirect: 'manual', // Don't follow redirects automatically
            credentials: 'same-origin', // Include cookies for authentication
            mode: 'same-origin' // Explicitly set to same-origin to avoid CORS
        })
        .then(response => {
            console.log('Accept ride response:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                redirected: response.redirected,
                url: response.url
            });
            
            // Handle success (200-299) or redirect (300-399)
            if (response.ok || (response.status >= 300 && response.status < 400)) {
                // Try to parse JSON response if available (AJAX request)
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    response.clone().json().then(data => {
                        if (data.booking_id) {
                            currentBookingId = data.booking_id;
                            console.log('Booking ID received from accept response:', currentBookingId);
                        }
                        console.log('Ride accepted successfully');
                        showToast('Ride accepted successfully!', 'success');
                        showDriverArrivedButton();
                        updateStatusCard('Ride Accepted', 'Heading to pickup location');
                    }).catch(() => {
                        // If JSON parsing fails, treat as redirect
                        handleAcceptSuccess(rideData.id);
                    });
                } else {
                    // Redirect response - fetch booking_id separately
                    handleAcceptSuccess(rideData.id);
                }
            } else if (response.status === 0) {
                // Status 0 usually means network error or CORS issue
                console.warn('Network error or CORS issue (status 0). Ride may still be accepted on server.');
                showToast('Ride accepted locally. Please check connection.', 'info');
            } else {
                console.warn('Ride acceptance returned non-ok status:', response.status, response.statusText);
                // Try to read response body for more details
                response.text().then(text => {
                    console.warn('Response body:', text);
                }).catch(() => {});
                showToast('Ride accepted! Map updated.', 'success');
            }
        })
        .catch(error => {
            console.error('Error accepting ride:', error);
            // Check if it's a network error
            if (error.message && error.message.includes('fetch')) {
                console.error('Network error - check internet connection or CORS settings');
            }
            showToast('Ride accepted locally. Syncing with server...', 'info');
        });
    }

    function rejectRideRequest() {
        if (!currentRideRequest) return;

        // Stop countdown
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        // Close popup immediately
        closeRideRequest();

        // Send AJAX request to reject the ride (non-blocking)
        fetch("{% url 'driver:reject_ride' 0 %}".replace('0', currentRideRequest.id), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'csrfmiddlewaretoken={{ csrf_token }}',
            redirect: 'manual'
        })
        .then(response => {
            console.log('Ride rejected successfully');
            showToast('Ride rejected', 'info');
        })
        .catch(error => {
            console.error('Error rejecting ride (non-blocking):', error);
            // Don't show alert, just log
        });
    }

    // Show non-blocking toast notification
    function showToast(message, type = 'info') {
        // Remove existing toast if any
        const existingToast = document.getElementById('toast-notification');
        if (existingToast) {
            existingToast.remove();
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.cssText = `
            position: fixed;
            top: 90px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#dc2626' : '#3b82f6'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2001;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            font-size: 14px;
            font-weight: 500;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function closeRideRequest() {
        const overlay = document.getElementById('ride-request-overlay');
        overlay.classList.remove('show');
        
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }

        currentRideRequest = null;
        countdownTime = 120;
    }

    // Draw route from driver to passenger pickup location
    function drawRouteToPassenger(driverCoords, passengerCoords, pickupAddress) {
        if (!map) {
            console.error('Map not initialized');
            return;
        }

        // Validate coordinates
        if (!Array.isArray(driverCoords) || driverCoords.length !== 2 ||
            !Array.isArray(passengerCoords) || passengerCoords.length !== 2) {
            console.error('Invalid coordinate arrays:', { driverCoords, passengerCoords });
            return;
        }

        const driverLat = parseFloat(driverCoords[0]);
        const driverLng = parseFloat(driverCoords[1]);
        const passengerLat = parseFloat(passengerCoords[0]);
        const passengerLng = parseFloat(passengerCoords[1]);

        if (isNaN(driverLat) || isNaN(driverLng) || isNaN(passengerLat) || isNaN(passengerLng)) {
            console.error('Invalid coordinate values:', {
                driverCoords,
                passengerCoords,
                parsed: { driverLat, driverLng, passengerLat, passengerLng }
            });
            return;
        }

        // Ensure coordinates are in valid range
        if (driverLat < -90 || driverLat > 90 || driverLng < -180 || driverLng > 180 ||
            passengerLat < -90 || passengerLat > 90 || passengerLng < -180 || passengerLng > 180) {
            console.error('Coordinates out of valid range:', {
                driver: [driverLat, driverLng],
                passenger: [passengerLat, passengerLng]
            });
            return;
        }

        // Additional validation: check if coordinates are reasonable
        if (!areReasonableCoordinates(passengerLat, passengerLng)) {
            console.error('Passenger coordinates seem invalid/unreasonable:', {
                passenger: [passengerLat, passengerLng],
                pickupAddress: pickupAddress
            });
            // Don't return - still try to draw, but log the warning
            console.warn('Drawing route with potentially invalid coordinates');
        }

        console.log('Drawing route:', {
            driver: [driverLat, driverLng],
            passenger: [passengerLat, passengerLng],
            address: pickupAddress
        });

        // Clear existing route and markers
        clearRoute();

        // Create passenger pickup marker with correct [lat, lng] order
        const passengerIcon = L.divIcon({
            className: 'passenger-icon-div',
            html: '<div class="passenger-marker-icon"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [50, 50],
            iconAnchor: [25, 50]
        });

        passengerMarker = L.marker([passengerLat, passengerLng], { icon: passengerIcon }).addTo(map);
        
        // Add popup to passenger marker
        passengerMarker.bindPopup(`<b>Pickup Location</b><br>${pickupAddress || 'Passenger Location'}`).openPopup();

        // Draw route polyline with smooth animation (using validated coordinates)
        const routePoints = [[driverLat, driverLng], [passengerLat, passengerLng]];
        routePolyline = L.polyline(routePoints, {
            color: '#00A59E',
            weight: 5,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(map);

        // Calculate distance and ETA
        const distance = calculateDistance(driverLat, driverLng, passengerLat, passengerLng);
        const eta = Math.ceil(distance / 0.5); // Assuming average speed of 30 km/h (0.5 km/min)

        // Fit map to show both locations with padding
        if (driverMarker && passengerMarker) {
            const group = new L.featureGroup([driverMarker, passengerMarker]);
            map.fitBounds(group.getBounds().pad(0.2), {
                animate: true,
                duration: 1.0
            });
        }

        // Show route info card
        showRouteInfo(distance, eta);

        console.log('Route drawn successfully:', {
            driver: [driverLat, driverLng],
            passenger: [passengerLat, passengerLng],
            distance: distance.toFixed(2) + ' km',
            eta: eta + ' min'
        });
    }


    // Show route info card on map
    function showRouteInfo(distance, eta) {
        // Remove existing info card if any
        if (routeInfoCard) {
            map.removeControl(routeInfoCard);
        }

        // Create custom control
        const RouteInfoControl = L.Control.extend({
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'route-info-card');
                div.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 200px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Distance to Pickup</div>
                        <div style="font-size: 24px; font-weight: 700; color: #00A59E; margin-bottom: 15px;">${distance.toFixed(1)} km</div>
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Estimated Time</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1f2937;">${eta} min</div>
      </div>
                `;
                return div;
            }
        });

        routeInfoCard = new RouteInfoControl({ position: 'topright' });
        routeInfoCard.addTo(map);
    }

    // Clear route and passenger marker
    function clearRoute() {
        if (passengerMarker) {
            map.removeLayer(passengerMarker);
            passengerMarker = null;
        }
        if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
        }
        if (routeInfoCard) {
            map.removeControl(routeInfoCard);
            routeInfoCard = null;
        }
    }

    // Simulate ride request (for testing - remove in production)
    function simulateRideRequest() {
        const mockRideData = {
            passengerName: 'John Doe',
            rating: '4.8',
            pickup: 'Mumbai Airport, Terminal 2',
            dropoff: 'Gateway of India, Mumbai',
            fare: '350',
            serviceType: 'Premium',
            id: 123
        };
        showRideRequest(mockRideData);
    }

    // Check for real ride requests (polling or WebSocket)
    function checkForRideRequests() {
        // Only check if popup is not currently showing
        const overlay = document.getElementById('ride-request-overlay');
        if (overlay.classList.contains('show')) {
            return; // Don't check for new requests while one is active
        }

        // Poll for new ride requests
        fetch("{% url 'driver:api_assigned_requests' %}")
            .then(response => response.json())
            .then(data => {
                if (data.assigned_request_ids && data.assigned_request_ids.length > 0) {
                    // Find new request IDs that we haven't processed
                    const newRequestIds = data.assigned_request_ids.filter(id => !processedRequestIds.has(id));
                    
                    if (newRequestIds.length > 0) {
                        // Fetch details for the first new request
                        const requestId = newRequestIds[0];
                        fetchRideRequestDetails(requestId);
                    }
                }
            })
            .catch(error => console.error('Error checking ride requests:', error));
    }

    // Fetch detailed ride request information
    function fetchRideRequestDetails(requestId) {
        const url = "{% url 'driver:api_ride_request_details' 0 %}".replace('0', requestId);
        console.log('Fetching ride request details from:', url);
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            credentials: 'same-origin' // Include cookies for authentication
        })
            .then(response => {
                console.log('Ride request details response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response body:', text);
                        throw new Error(`Failed to fetch ride request details: ${response.status} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(rideData => {
                console.log('Ride request details received:', {
                    id: rideData.id,
                    pickupLat: rideData.pickupLat,
                    pickupLng: rideData.pickupLng,
                    pickup: rideData.pickup
                });
                
                // Validate coordinates in response
                if (rideData.pickupLat === null || rideData.pickupLat === undefined ||
                    rideData.pickupLng === null || rideData.pickupLng === undefined) {
                    console.error('Missing coordinates in API response:', rideData);
                }
                
                // Show the popup with ride request details
                showRideRequest(rideData);
            })
            .catch(error => {
                console.error('Error fetching ride request details:', error);
                showToast('Failed to load ride request details', 'error');
            });
    }

    // Show Driver Arrived button
    function showDriverArrivedButton() {
        const container = document.getElementById('driver-arrived-button-container');
        if (container) {
            container.style.display = 'block';
        }
    }

    // Hide Driver Arrived button
    function hideDriverArrivedButton() {
        const container = document.getElementById('driver-arrived-button-container');
        if (container) {
            container.style.display = 'none';
        }
    }

    // Update status card
    function updateStatusCard(statusText, subMessage) {
        const statusMessage = document.getElementById('status-message');
        const statusSubmessage = document.getElementById('status-submessage');
        if (statusMessage) {
            statusMessage.innerHTML = `<span class="status-indicator"></span>${statusText}`;
        }
        if (statusSubmessage) {
            statusSubmessage.textContent = subMessage;
        }
    }

    // Handle successful ride acceptance
    function handleAcceptSuccess(rideRequestId) {
        console.log('Ride accepted successfully (redirect)');
        showToast('Ride accepted successfully!', 'success');
        showDriverArrivedButton();
        updateStatusCard('Ride Accepted', 'Heading to pickup location');
        
        // Try to get booking_id by fetching the ride request details
        // The booking should be linked to the ride_request after acceptance
        setTimeout(() => {
            getBookingIdFromRideRequest(rideRequestId);
        }, 1000);
    }

    // Get booking ID from ride request ID
    async function getBookingIdFromRideRequest(rideRequestId) {
        try {
            const response = await fetch("{% url 'driver:api_ride_request_details' 0 %}".replace('0', rideRequestId));
            if (response.ok) {
                const data = await response.json();
                if (data.booking_id) {
                    currentBookingId = data.booking_id;
                    console.log('Booking ID retrieved:', currentBookingId);
                } else {
                    console.warn('Booking ID not yet available in ride request');
                }
            }
        } catch (error) {
            console.error('Error getting booking ID:', error);
        }
    }

    // Handle Driver Arrived button click
    async function handleDriverArrived() {
        // If we don't have booking_id, try to get it from the current ride request
        if (!currentBookingId && currentRideRequest) {
            try {
                const response = await fetch("{% url 'driver:api_ride_request_details' 0 %}".replace('0', currentRideRequest.id));
                if (response.ok) {
                    const data = await response.json();
                    if (data.booking_id) {
                        currentBookingId = data.booking_id;
                        console.log('Booking ID retrieved:', currentBookingId);
                        // Continue with the arrival notification
                    } else {
                        showToast('Booking not found. Please refresh the page.', 'error');
                        return;
                    }
                } else {
                    showToast('Unable to get booking information', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error fetching booking ID:', error);
                showToast('Unable to get booking information', 'error');
                return;
            }
        }
        
        if (!currentBookingId) {
            console.error('No active booking ID');
            showToast('No active booking found. Please refresh the page.', 'error');
            return;
        }

        const btn = document.getElementById('driver-arrived-btn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Notifying...</span>';
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrfToken = getCookie('csrftoken') || '{{ csrf_token }}';
        const arrivedUrl = "{% url 'driver:arrived_ride' 0 %}".replace('0', currentBookingId);

        fetch(arrivedUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `csrfmiddlewaretoken=${encodeURIComponent(csrfToken)}`,
            credentials: 'same-origin',
            mode: 'same-origin'
        })
        .then(response => {
            if (response.ok || response.redirected) {
                console.log('Driver arrived notification sent');
                showToast('Passenger notified: Driver has arrived!', 'success');
                updateStatusCard('Driver Arrived', 'Waiting for passenger');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i><span>Arrived</span>';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-map-marker-alt"></i><span>Driver Arrived</span>';
                    }, 2000);
                }
            } else {
                throw new Error(`Failed to send arrival notification: ${response.status}`);
            }
        })
        .catch(error => {
            console.error('Error sending arrival notification:', error);
            showToast('Failed to send arrival notification', 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i><span>Driver Arrived</span>';
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        initMap();

        // Check for ride requests every 5 seconds (if driver is online)
        const availabilityToggle = document.getElementById('availability-toggle');
        if (availabilityToggle && availabilityToggle.checked) {
            setInterval(checkForRideRequests, 5000);
        }

        // Add event listener for Driver Arrived button
        const driverArrivedBtn = document.getElementById('driver-arrived-btn');
        if (driverArrivedBtn) {
            driverArrivedBtn.addEventListener('click', handleDriverArrived);
        }

        // For testing: Add a button to simulate ride request (remove in production)
        // Uncomment the line below to test the notification
        // setTimeout(simulateRideRequest, 5000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
    });
</script>
</body>
</html>
