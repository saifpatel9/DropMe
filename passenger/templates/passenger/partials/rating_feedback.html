<style>
  /* Custom star rating styles */
  .star-rating {
    display: flex;
    flex-direction: row-reverse;
    font-size: 1.5rem;
    justify-content: center;
    padding: 0.5rem;
    gap: 0.25rem;
    margin-bottom: 0.75rem;
  }

  .star-rating input {
    display: none;
  }

  .star-rating label {
    color: #d1d5db;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(1);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .star-rating label:hover {
    color: #fbbf24;
    transform: scale(1.15);
    filter: drop-shadow(0 4px 8px rgba(251, 191, 36, 0.3));
  }

  .star-rating input:checked ~ label {
    color: #f59e0b;
    animation: starGlow 0.3s ease-out;
  }

  .star-rating label:hover ~ label {
    color: #fbbf24;
  }

  @keyframes starGlow {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); color: #fcd34d; }
    100% { transform: scale(1.1); }
  }

  /* Enhanced form styles */
  .form-input {
    transition: all 0.3s ease;
    background: linear-gradient(145deg, #ffffff, #f8fafc);
  }

  .form-input:focus {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(20, 184, 166, 0.15);
    background: #ffffff;
  }

  /* Enhanced card styles */
  .ride-card {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    border: 1px solid transparent;
    position: relative;
    overflow: hidden;
  }

  .ride-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(20, 184, 166, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .ride-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 25px 50px rgba(20, 184, 166, 0.15);
    border-color: rgba(20, 184, 166, 0.2);
  }

  .ride-card:hover::before {
    left: 100%;
  }

  /* Enhanced button styles */
  .btn-submit {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #14b8a6, #0f766e);
    position: relative;
    overflow: hidden;
  }

  .btn-submit:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(20, 184, 166, 0.4);
    background: linear-gradient(135deg, #0f766e, #0d9488);
  }

  .btn-submit:active {
    transform: translateY(-1px);
  }

  .btn-submit:disabled {
    background: linear-gradient(135deg, #9ca3af, #6b7280);
    cursor: not-allowed;
    opacity: 0.6;
  }

  /* Success state styles */
  .submitted-state {
    background: linear-gradient(145deg, #ecfdf5, #d1fae5);
    border-color: #10b981;
    animation: successPulse 0.6s ease-out;
  }

  @keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .success-icon {
    animation: checkmark 0.5s ease-out;
  }

  @keyframes checkmark {
    0% { transform: scale(0) rotate(45deg); }
    50% { transform: scale(1.2) rotate(45deg); }
    100% { transform: scale(1) rotate(45deg); }
  }

  /* Message animations */
  .message-slide {
    animation: slideInDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideInDown {
    from {
      transform: translateY(-30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Rating display enhancement */
  .rating-display {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-weight: 600;
    color: #92400e;
  }

  .rating-display.show {
    opacity: 1;
    transform: scale(1.05);
  }

  /* Character counter enhancement */
  .char-counter {
    transition: all 0.3s ease;
    font-size: 0.75rem;
    font-weight: 500;
  }

  /* Enhanced submitted ratings */
  .submitted-rating {
    background: linear-gradient(145deg, #f0fdfa, #ccfbf1);
    border-left: 4px solid #14b8a6;
    transition: all 0.3s ease;
  }

  .submitted-rating:hover {
    transform: translateX(5px);
    box-shadow: 0 10px 25px rgba(20, 184, 166, 0.1);
  }

  /* Loading spinner for form submission */
  .spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid #14b8a6;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Floating elements */
  .floating {
    animation: floating 3s ease-in-out infinite;
  }

  @keyframes floating {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }

  /* Rating stats visual enhancement */
  .rating-stats {
    background: linear-gradient(145deg, #fef7ff, #fae8ff);
    border: 1px solid #e879f9;
  }

  /* Hide submit button after successful submission */
  .form-submitted .btn-submit {
    display: none;
  }

  /* Show success message after submission */
  .form-submitted .success-message {
    display: block;
  }

  .success-message {
    display: none;
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border: 2px solid #10b981;
    color: #065f46;
    padding: 1rem;
    border-radius: 0.75rem;
    text-align: center;
    font-weight: 600;
    animation: successSlide 0.5s ease-out;
  }

  @keyframes successSlide {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<div class="bg-white shadow-2xl rounded-3xl p-10 border border-gray-100 max-w-6xl mx-auto mt-8 relative overflow-hidden">
  
  <!-- Decorative background elements -->
  <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-teal-400/10 to-cyan-400/10 rounded-full -translate-y-32 translate-x-32"></div>
  <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-purple-400/10 to-pink-400/10 rounded-full translate-y-24 -translate-x-24"></div>
  
  <!-- Header -->
  <div class="text-center mb-12 pb-8 border-b border-gray-200 relative">
    <div class="floating mb-4">
      <i class="fas fa-star text-4xl text-yellow-400 drop-shadow-lg"></i>
    </div>
    <h2 class="text-4xl font-bold bg-gradient-to-r from-teal-700 to-teal-500 bg-clip-text text-transparent mb-3">
      Rating & Feedback
    </h2>
    <p class="text-lg text-teal-600 mb-6">Help us improve your ride experience</p>
    <div class="w-32 h-1.5 bg-gradient-to-r from-teal-400 via-cyan-400 to-teal-600 mx-auto rounded-full shadow-lg"></div>
    
    <!-- Stats section -->
    <div class="flex justify-center mt-6 space-x-6">
      <div class="rating-stats rounded-xl px-4 py-2">
        <div class="text-sm font-semibold text-purple-700">Total Rides</div>
        <div class="text-xl font-bold text-purple-800">{{ rides_without_rating|length|add:passenger_ratings|length }}</div>
      </div>
      <div class="rating-stats rounded-xl px-4 py-2">
        <div class="text-sm font-semibold text-purple-700">Rated</div>
        <div class="text-xl font-bold text-purple-800">{{ passenger_ratings|length }}</div>
      </div>
    </div>
  </div>

  <!-- Messages with enhanced styling -->
  {% if messages %}
    <div class="mb-8">
      {% for message in messages %}
        <div class="message-slide p-4 mb-4 rounded-xl border-l-4 {% if message.tags == 'success' %}bg-green-50 border-green-400 text-green-700{% else %}bg-red-50 border-red-400 text-red-700{% endif %} shadow-md">
          <div class="flex items-center">
            {% if message.tags == 'success' %}
              <i class="fas fa-check-circle mr-2"></i>
            {% else %}
              <i class="fas fa-exclamation-triangle mr-2"></i>
            {% endif %}
            {{ message }}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Pending Ratings Section -->
  <div class="mb-12">
    <div class="flex items-center mb-6">
      <i class="fas fa-clock text-2xl text-orange-400 mr-3"></i>
      <h3 class="text-3xl font-bold text-gray-800">Pending Ratings</h3>
      {% if rides_without_rating %}
        <div class="ml-4 bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold">
          {{ rides_without_rating|length }} ride{{ rides_without_rating|length|pluralize }}
        </div>
      {% endif %}
    </div>
    
    {% if rides_without_rating %}
      <div class="space-y-8">
        {% for ride in rides_without_rating %}
          <div class="ride-card rounded-2xl p-8 shadow-lg" data-ride-id="{{ ride.booking_id }}">
            <div class="flex justify-between items-start mb-6">
              <div class="flex-1">
                <div class="flex items-center mb-2">
                  <i class="fas fa-route text-teal-500 mr-2"></i>
                  <p class="text-gray-800 font-bold text-lg">Ride #{{ ride.booking_id }}</p>
                </div>
                <div class="flex items-center text-gray-600 mb-2">
                  <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>
                  <span class="font-medium">{{ ride.pickup_location }}</span>
                  <i class="fas fa-arrow-right text-gray-400 mx-3"></i>
                  <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                  <span class="font-medium">{{ ride.dropoff_location }}</span>
                </div>
                <div class="flex items-center text-gray-500 text-sm">
                  <i class="fas fa-user-tie text-blue-500 mr-2"></i>
                  <span>Driver: {{ ride.driver.first_name }} {{ ride.driver.last_name }}</span>
                  {% if ride.driver.vehicle_type and ride.driver.vehicle_number %}
                    <span class="mx-2">â€¢</span>
                    <i class="fas fa-car text-gray-500 mr-1"></i>
                    <span>{{ ride.driver.vehicle_type }} - {{ ride.driver.vehicle_number }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="text-right">
                <div class="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm font-semibold mb-2">
                  â‚¹{{ ride.fare }}
                </div>
                <div class="text-xs text-gray-500">
                  <i class="fas fa-calendar mr-1"></i>
                  {{ ride.scheduled_time|date:"M j, Y, g:i a" }}
                </div>
              </div>
            </div>
            
            <form method="POST" action="{% url 'submit_rating' ride.pk %}" class="space-y-4">
              {% csrf_token %}
              
              <!-- Star Rating -->
              <div class="text-center">
                <label class="block text-sm font-semibold text-gray-700 mb-3">Rate your experience</label>
                <div class="star-rating" id="star-rating-{{ ride.booking_id }}">
                  {% for star in "54321" %}
                    <input type="radio" id="star{{ star }}-{{ ride.booking_id }}" name="rating" value="{{ star }}" required>
                    <label for="star{{ star }}-{{ ride.booking_id }}" data-value="{{ star }}">â˜…</label>
                  {% endfor %}
                </div>
                <div id="rating-text-{{ ride.booking_id }}" class="rating-display mt-2 inline-block">
                  Select your rating
                </div>
              </div>

              <!-- Feedback Textarea -->
              <div class="relative">
                <label for="comments-{{ ride.booking_id }}" class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-comment-dots mr-1"></i>
                  Share your feedback
                </label>
                <textarea 
                  id="comments-{{ ride.booking_id }}"
                  name="comments" 
                  rows="4"
                  maxlength="500"
                  class="form-input w-full border-2 border-gray-200 rounded-xl p-4 focus:ring-teal-500 focus:border-teal-500 resize-none"
                  placeholder="Tell us about your ride experience... (optional)"
                  oninput="updateCharCount(this, '{{ ride.booking_id }}')"
                ></textarea>
                <div class="absolute bottom-3 right-3 char-counter text-gray-400">
                  <span id="char-count-{{ ride.booking_id }}">0</span>/500
                </div>
              </div>

              <!-- Submit Button -->
              <div class="text-center">
                <button type="submit" class="btn-submit text-white px-8 py-3 rounded-xl font-semibold text-lg shadow-lg transform transition-all duration-300 hover:shadow-2xl">
                  <span class="button-text">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Rating
                  </span>
                  <span class="loading-text hidden">
                    <div class="spinner inline-block"></div>
                    Submitting...
                  </span>
                </button>
              </div>

              <!-- Success message (hidden by default) -->
              <div class="success-message">
                <i class="fas fa-check-circle text-green-500 mr-2 success-icon"></i>
                Rating submitted successfully!
              </div>
            </form>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-12">
        <div class="floating mb-4">
          <i class="fas fa-thumbs-up text-4xl text-green-400"></i>
        </div>
        <p class="text-gray-500 text-lg">No rides pending feedback ðŸŽ‰</p>
        <p class="text-gray-400 text-sm mt-2">You're all caught up!</p>
      </div>
    {% endif %}
  </div>

  <!-- Submitted Ratings Section -->
  <div class="mb-8">
    <div class="flex items-center mb-6">
      <i class="fas fa-check-circle text-2xl text-green-500 mr-3"></i>
      <h3 class="text-3xl font-bold text-gray-800">Submitted Ratings</h3>
      {% if passenger_ratings %}
        <div class="ml-4 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
          {{ passenger_ratings|length }} review{{ passenger_ratings|length|pluralize }}
        </div>
      {% endif %}
    </div>
    
    {% if passenger_ratings %}
      <div class="space-y-6">
        {% for rating in passenger_ratings %}
          <div class="submitted-rating rounded-xl p-6 shadow-md">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <div class="flex items-center mb-2">
                  <i class="fas fa-route text-teal-500 mr-2"></i>
                  <p class="text-gray-800 font-bold text-lg">Ride #{{ rating.booking.booking_id }}</p>
                </div>
                <div class="flex items-center text-gray-600 mb-2">
                  <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>
                  <span class="font-medium">{{ rating.booking.pickup_location }}</span>
                  <i class="fas fa-arrow-right text-gray-400 mx-3"></i>
                  <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                  <span class="font-medium">{{ rating.booking.dropoff_location }}</span>
                </div>
                <div class="flex items-center text-gray-500 text-sm mb-3">
                  <i class="fas fa-user-tie text-blue-500 mr-2"></i>
                  <span>Driver: {{ rating.driver.first_name }} {{ rating.driver.last_name }}</span>
                </div>
                <div class="flex items-center mb-2">
                  <div class="flex text-xl mr-3">
                    {% for i in "12345"|make_list %}
                      <span class="{% if rating.rating|default:0 >= i|add:0 %}text-yellow-400{% else %}text-gray-300{% endif %} transition-colors duration-200">â˜…</span>
                    {% endfor %}
                  </div>
                  <span class="text-sm text-gray-500 font-medium">({{ rating.rating }}/5)</span>
                </div>
              </div>
              <div class="text-right">
                <div class="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm font-semibold mb-2">
                  â‚¹{{ rating.booking.fare }}
                </div>
                <div class="text-xs text-gray-500">
                  <i class="fas fa-calendar mr-1"></i>
                  {{ rating.created_at|date:"M j, Y, g:i a" }}
                </div>
              </div>
            </div>
            
            {% if rating.comments %}
              <div class="bg-white rounded-lg p-4 border-l-4 border-teal-400 shadow-sm">
                <i class="fas fa-quote-left text-gray-400 mr-2"></i>
                <span class="italic text-gray-700">{{ rating.comments }}</span>
                <i class="fas fa-quote-right text-gray-400 ml-2"></i>
              </div>
            {% else %}
              <div class="bg-gray-50 rounded-lg p-3 text-center text-gray-500 text-sm italic">
                No additional comments provided
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-12">
        <div class="floating mb-4">
          <i class="fas fa-star-half-alt text-4xl text-gray-400"></i>
        </div>
        <p class="text-gray-500 text-lg">You haven't submitted any ratings yet</p>
        <p class="text-gray-400 text-sm mt-2">Complete a ride to leave your first review!</p>
      </div>
    {% endif %}
  </div>

  <!-- Footer Message -->
  <div class="text-center mt-10 pt-8 border-t border-gray-100">
    <div class="floating mb-4">
      <i class="fas fa-heart text-2xl text-pink-400"></i>
    </div>
    <p class="text-gray-600 text-lg mb-4">Your feedback helps us improve our service quality</p>
    <div class="flex justify-center space-x-6 text-sm text-gray-500">
      <div class="flex items-center">
        <i class="fas fa-shield-alt text-teal-500 mr-1"></i>
        <span>Secure & Private</span>
      </div>
      <div class="flex items-center">
        <i class="fas fa-clock text-teal-500 mr-1"></i>
        <span>Quick & Easy</span>
      </div>
      <div class="flex items-center">
        <i class="fas fa-thumbs-up text-teal-500 mr-1"></i>
        <span>Your Voice Matters</span>
      </div>
    </div>
  </div>
</div>

<script>
  // Enhanced star rating functionality
  document.addEventListener('DOMContentLoaded', function() {
    initializeStarRatings();
    initializeCharacterCounters();
    initializeFormSubmissions();
  });

  function initializeStarRatings() {
    document.querySelectorAll('.star-rating').forEach(function(rating) {
      const rideId = rating.id.split('-')[2];
      const stars = rating.querySelectorAll('label');
      const inputs = rating.querySelectorAll('input');
      
      stars.forEach(function(star, index) {
        star.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          updateStarDisplay(rideId, value);
          updateRatingText(rideId, value);
        });
        
        star.addEventListener('mouseover', function() {
          const value = this.getAttribute('data-value');
          highlightStars(rideId, value, true);
        });
      });
      
      rating.addEventListener('mouseleave', function() {
        const checkedInput = rating.querySelector('input:checked');
        if (checkedInput) {
          const value = checkedInput.value;
          highlightStars(rideId, value, false);
        } else {
          resetStars(rideId);
        }
      });
    });
  }

  function highlightStars(rideId, rating, isHover) {
    const stars = document.querySelectorAll(`#star-rating-${rideId} label`);
    const ratingNum = parseInt(rating);
    
    stars.forEach(function(star, index) {
      const starValue = parseInt(star.getAttribute('data-value'));
      if (starValue <= ratingNum) {
        star.style.color = isHover ? '#fbbf24' : '#f59e0b';
        star.style.transform = isHover ? 'scale(1.15)' : 'scale(1.1)';
      } else {
        star.style.color = '#d1d5db';
        star.style.transform = 'scale(1)';
      }
    });
  }

  function updateStarDisplay(rideId, rating) {
    const stars = document.querySelectorAll(`#star-rating-${rideId} label`);
    const ratingNum = parseInt(rating);
    
    stars.forEach(function(star) {
      const starValue = parseInt(star.getAttribute('data-value'));
      if (starValue <= ratingNum) {
        star.style.color = '#f59e0b';
        star.style.transform = 'scale(1.1)';
        star.style.animation = 'starGlow 0.3s ease-out';
      } else {
        star.style.color = '#d1d5db';
        star.style.transform = 'scale(1)';
      }
    });
    
    // Clear animation after it completes
    setTimeout(() => {
      stars.forEach(star => {
        star.style.animation = '';
      });
    }, 300);
  }

  function resetStars(rideId) {
    const stars = document.querySelectorAll(`#star-rating-${rideId} label`);
    stars.forEach(function(star) {
      star.style.color = '#d1d5db';
      star.style.transform = 'scale(1)';
    });
  }

  function updateRatingText(rideId, rating) {
    const ratingTexts = {
      1: '1 Star - Poor Experience',
      2: '2 Stars - Below Average', 
      3: '3 Stars - Average',
      4: '4 Stars - Good Experience',
      5: '5 Stars - Excellent!'
    };
    
    const textElement = document.getElementById(`rating-text-${rideId}`);
    if (textElement) {
      textElement.textContent = ratingTexts[rating];
      textElement.classList.add('show');
      
      // Add bounce effect
      textElement.style.transform = 'scale(1.1)';
      setTimeout(() => {
        textElement.style.transform = 'scale(1.05)';
      }, 200);
    }
  }

  function updateCharCount(textarea, rideId) {
    const count = textarea.value.length;
    const maxLength = 500;
    
    const countElement = document.getElementById(`char-count-${rideId}`);
    if (countElement) {
      countElement.textContent = count;
      
      if (count > maxLength * 0.9) {
        countElement.classList.add('text-orange-500', 'font-bold');
        countElement.classList.remove('text-gray-400', 'text-yellow-500');
      } else if (count > maxLength * 0.7) {
        countElement.classList.add('text-yellow-500');
        countElement.classList.remove('text-gray-400', 'text-orange-500', 'font-bold');
      } else {
        countElement.classList.remove('text-orange-500', 'text-yellow-500', 'font-bold');
        countElement.classList.add('text-gray-400');
      }
    }
  }

  function initializeCharacterCounters() {
    const textareas = document.querySelectorAll('textarea[name="comments"]');
    textareas.forEach(function(textarea) {
      const rideId = textarea.id.split('-')[1];
      updateCharCount(textarea, rideId);
    });
  }

  function initializeFormSubmissions() {
    document.querySelectorAll('.rating-form').forEach(function(form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const rideId = this.getAttribute('data-ride-id');
        const submitButton = this.querySelector('.btn-submit');
        const buttonText = submitButton.querySelector('.button-text');
        const loadingText = submitButton.querySelector('.loading-text');
        const successMessage = this.querySelector('.success-message');
        const rideCard = this.closest('.ride-card');
        
        // Show loading state
        submitButton.disabled = true;
        buttonText.classList.add('hidden');
        loadingText.classList.remove('hidden');
        
        // Simulate form submission (replace with actual submission)
        setTimeout(() => {
          // Hide the form and show success
          this.classList.add('form-submitted');
          rideCard.classList.add('submitted-state');
          successMessage.classList.add('show');
          
          // Add success animation to the entire card
          rideCard.style.animation = 'successPulse 0.6s ease-out';
          
          setTimeout(() => {
            rideCard.style.animation = '';
          }, 600);
        }, 1500);
        
        // For actual Django implementation, remove the preventDefault and setTimeout,
        // and let the form submit normally. The success state should be handled
        // by Django redirects or AJAX responses.
      });
    });
  }
</script>

</body>
</html>