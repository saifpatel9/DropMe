{% load custom_filters %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

  :root {
    --brand:          #00C896;
    --brand-dark:     #00A87D;
    --brand-light:    #E6FBF5;
    --brand-glow:     rgba(0, 200, 150, 0.20);
    --surface:        #FFFFFF;
    --surface-2:      #F7FAFA;
    --border:         #E8F0EE;
    --text-primary:   #0D2622;
    --text-secondary: #5A7A75;
    --text-muted:     #9BB5B0;
    --shadow-sm:      0 2px 8px rgba(0, 40, 30, 0.06);
    --shadow-md:      0 8px 24px rgba(0, 40, 30, 0.10);
    --radius-xl:      24px;
    --radius-lg:      16px;
    --radius-md:      12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  .app-shell {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--surface-2);
    min-height: 100vh;
    padding-bottom: 40px;
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
  }

  /* ── Sticky top bar ── */
  .app-topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 18px 20px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .topbar-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 4px 12px var(--brand-glow);
  }

  .topbar-icon svg { width: 20px; height: 20px; stroke: #fff; }
  .topbar-title    { font-size: 18px; font-weight: 800; color: var(--text-primary); letter-spacing: -0.3px; }
  .topbar-sub      { font-size: 12px; font-weight: 500; color: var(--text-muted); margin-top: 1px; }

  .topbar-count {
    margin-left: auto;
    font-size: 12px;
    font-weight: 700;
    color: var(--brand-dark);
    background: var(--brand-light);
    border: 1px solid #9FECDA;
    border-radius: 20px;
    padding: 3px 10px;
    flex-shrink: 0;
  }

  /* ── Filter pills ── */
  .filter-scroll {
    display: flex;
    gap: 8px;
    padding: 16px 16px 0;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .filter-scroll::-webkit-scrollbar { display: none; }

  .filter-pill {
    flex-shrink: 0;
    padding: 7px 16px;
    border-radius: 20px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }

  .filter-pill.active,
  .filter-pill:active {
    background: var(--brand);
    border-color: var(--brand);
    color: #fff;
  }

  /* ── Section summary ── */
  .rides-summary {
    padding: 14px 20px 0;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ── Ride card ── */
  .ride-cards-wrap { padding: 12px 16px 0; display: flex; flex-direction: column; gap: 10px; }

  .ride-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .ride-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 16px 18px 12px;
    border-bottom: 1px solid var(--border);
  }

  .ride-id-wrap { display: flex; align-items: center; gap: 8px; }

  .ride-id-icon {
    width: 34px;
    height: 34px;
    border-radius: 10px;
    background: var(--brand-light);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .ride-id-icon svg { width: 16px; height: 16px; stroke: var(--brand-dark); }

  .ride-id-text  { font-size: 14px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.1px; }
  .ride-datetime { font-size: 11px; font-weight: 500; color: var(--text-muted); margin-top: 2px; }

  /* ── Status badges — flat, no gradient ── */
  .status-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.2px;
    flex-shrink: 0;
  }

  .status-completed { background: #DCFCE7; color: #166534; }
  .status-pending   { background: #FEF9C3; color: #854D0E; }
  .status-ongoing   { background: #DBEAFE; color: #1D4ED8; }
  .status-cancelled { background: #FEE2E2; color: #991B1B; }
  .status-cancelled-passenger { background: #FEE2E2; color: #991B1B; }
  .status-cancelled-driver { background: #FFF1E8; color: #9A3412; }

  /* ── Route section ── */
  .ride-card-route {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .route-stop {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .route-dot {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .route-dot.green { background: #22C55E; }
  .route-dot.red   { background: #EF4444; }

  .route-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; }
  .route-place { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-top: 1px; line-height: 1.3; }

  .route-connector {
    width: 1px;
    height: 10px;
    background: var(--border);
    margin-left: 4px;
  }

  /* ── Fare / action row ── */
  .ride-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 18px;
  }

  .ride-fare {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-primary);
    letter-spacing: -0.3px;
  }

  .ride-fare span { font-size: 13px; font-weight: 600; color: var(--text-muted); }

  .btn-details {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--brand-dark);
    background: var(--brand-light);
    border: 1px solid #9FECDA;
    border-radius: 20px;
    padding: 6px 14px;
    cursor: pointer;
    transition: background 0.15s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .btn-details:hover { background: #C8F7EC; }

  /* ── Ride details modal ── */
  .ride-details-modal {
    position: fixed;
    inset: 0;
    background: rgba(13, 38, 34, 0.45);
    display: none;
    align-items: flex-end;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.18s ease;
  }

  .ride-details-modal.is-open {
    display: flex;
    opacity: 1;
    pointer-events: auto;
  }

  .ride-details-sheet {
    width: 100%;
    max-width: 620px;
    background: var(--surface);
    border-radius: 22px 22px 0 0;
    padding: 14px 16px 22px;
    box-shadow: 0 -8px 30px rgba(0, 40, 30, 0.18);
    transform: translateY(14px);
    transition: transform 0.18s ease;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
    z-index: 1;
  }

  .ride-details-modal.is-open .ride-details-sheet {
    transform: translateY(0);
  }

  .sheet-handle {
    width: 42px;
    height: 5px;
    border-radius: 999px;
    background: #d7e6e3;
    margin: 0 auto 12px;
  }

  .sheet-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 12px;
  }

  .sheet-title {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-primary);
    letter-spacing: -0.2px;
  }

  .sheet-close {
    border: 1px solid var(--border);
    background: #f6faf9;
    color: var(--text-secondary);
    width: 34px;
    height: 34px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
  }

  .sheet-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 12px;
  }

  .sheet-booking {
    font-size: 12px;
    font-weight: 700;
    color: var(--brand-dark);
    background: var(--brand-light);
    border: 1px solid #9FECDA;
    border-radius: 20px;
    padding: 4px 10px;
  }

  .details-list {
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    background: #fcfefe;
  }

  .details-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 14px;
    padding: 11px 12px;
    border-bottom: 1px solid var(--border);
  }

  .details-row:last-child { border-bottom: none; }

  .details-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    flex-shrink: 0;
  }

  .details-value {
    text-align: right;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.4;
    word-break: break-word;
  }

  body.ride-modal-open { overflow: hidden; }

  /* ── Empty state ── */
  .empty-state {
    text-align: center;
    padding: 56px 24px;
  }

  .empty-icon {
    width: 72px;
    height: 72px;
    border-radius: 22px;
    background: var(--surface);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 18px;
    box-shadow: var(--shadow-sm);
  }

  .empty-icon svg { width: 32px; height: 32px; stroke: var(--text-muted); }

  .empty-title { font-size: 17px; font-weight: 800; color: var(--text-primary); margin-bottom: 6px; }
  .empty-desc  { font-size: 13px; font-weight: 500; color: var(--text-muted); line-height: 1.6; max-width: 260px; margin: 0 auto 24px; }

  .btn-book {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--brand);
    color: #fff;
    border: none;
    border-radius: var(--radius-lg);
    padding: 14px 32px;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 16px var(--brand-glow);
    transition: background 0.15s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .btn-book:hover  { background: var(--brand-dark); }
  .btn-book svg    { width: 18px; height: 18px; stroke: #fff; }

  /* ── Fade transition for filter ── */
  .ride-card { transition: opacity 0.15s ease; }
  .ride-card[style*="none"] { opacity: 0; }
</style>

<div class="app-shell">

  <!-- Top bar -->
  <div class="app-topbar">
    <div class="topbar-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
    </div>
    <div>
      <div class="topbar-title">My Rides</div>
      <div class="topbar-sub">Track your trips and history</div>
    </div>
    {% if rides %}
      <div class="topbar-count">{{ rides|length }} ride{{ rides|length|pluralize }}</div>
    {% endif %}
  </div>

  {% if rides %}

    <!-- Filter pills -->
    <div class="filter-scroll">
      <div class="filter-pill active" data-filter="all"       onclick="filterRides('all')">All</div>
      <div class="filter-pill"        data-filter="completed" onclick="filterRides('completed')">Completed</div>
      <div class="filter-pill"        data-filter="pending"   onclick="filterRides('pending')">Pending</div>
      <div class="filter-pill"        data-filter="ongoing"   onclick="filterRides('ongoing')">Ongoing</div>
      <div class="filter-pill"        data-filter="cancelled" onclick="filterRides('cancelled')">Cancelled</div>
    </div>

    <!-- Ride cards -->
    <div class="ride-cards-wrap" id="rides-container">
      {% for ride in rides %}
        <div class="ride-card" data-status="{{ ride.status|lower }}">

          <!-- Top: booking ID + status -->
          <div class="ride-card-top">
            <div class="ride-id-wrap">
              <div class="ride-id-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
              </div>
              <div>
                <div class="ride-id-text">#{{ ride.booking_id }}</div>
                <div class="ride-datetime">{{ ride.scheduled_time|date:"d M Y · h:i A" }}</div>
              </div>
            </div>
            <span class="status-badge {% if ride.status == 'CancelledByPassenger' %}status-cancelled-passenger{% elif ride.status == 'CancelledByDriver' %}status-cancelled-driver{% elif ride.status and 'Cancelled' in ride.status %}status-cancelled{% else %}status-{{ ride.status|lower }}{% endif %}">
              {% if ride.status == 'CancelledByPassenger' %}
                Cancelled by Passenger
              {% elif ride.status == 'CancelledByDriver' %}
                Cancelled by Driver
              {% elif ride.status == 'Cancelled' %}
                Cancelled
              {% elif ride.status %}
                {{ ride.status|title }}
              {% else %}
                Unknown
              {% endif %}
            </span>
          </div>

          <!-- Route -->
          <div class="ride-card-route">
            <div class="route-stop">
              <div class="route-dot green"></div>
              <div>
                <div class="route-label">Pickup</div>
                <div class="route-place">{{ ride.pickup_location|before_comma }}</div>
              </div>
            </div>
            <div class="route-connector" style="margin-left: 4px;"></div>
            <div class="route-stop">
              <div class="route-dot red"></div>
              <div>
                <div class="route-label">Dropoff</div>
                <div class="route-place">{{ ride.dropoff_location|before_comma }}</div>
              </div>
            </div>
          </div>

          <!-- Fare + View Details -->
          <div class="ride-card-footer">
            <div class="ride-fare">₹{{ ride.fare }}</div>
            <button
              class="btn-details js-view-ride-details"
              type="button"
              data-booking-id="{{ ride.booking_id }}"
              data-driver-name="{% if ride.driver %}{{ ride.driver.first_name|default:'' }} {{ ride.driver.last_name|default:'' }}{% else %}Not assigned{% endif %}"
              data-ride-type="{% if ride.service_type and ride.service_type.name %}{{ ride.service_type.name }}{% else %}Not available{% endif %}"
              data-fare="{% if ride.fare %}₹{{ ride.fare }}{% else %}Not available{% endif %}"
              data-date-time="{% if ride.scheduled_time %}{{ ride.scheduled_time|date:'d M Y · h:i A' }}{% else %}Not scheduled{% endif %}"
              data-pickup="{% if ride.pickup_location %}{{ ride.pickup_location }}{% else %}Not available{% endif %}"
              data-dropoff="{% if ride.dropoff_location %}{{ ride.dropoff_location }}{% else %}Not available{% endif %}"
              data-distance="{% if ride.distance_km %}{{ ride.distance_km|floatformat:1 }} km{% else %}Not available{% endif %}"
              data-duration="{% if ride.duration_min %}{{ ride.duration_min }} min{% else %}Not available{% endif %}"
              data-status="{% if ride.status == 'CancelledByPassenger' %}Cancelled by Passenger{% elif ride.status == 'CancelledByDriver' %}Cancelled by Driver{% elif ride.status == 'Cancelled' %}Cancelled{% elif ride.status %}{{ ride.status|title }}{% else %}Unknown{% endif %}"
              data-payment-mode="{% if ride.payment_mode %}{{ ride.payment_mode }}{% else %}Not selected{% endif %}"
              data-cancelled-by="{% if ride.cancelled_by %}{{ ride.cancelled_by }}{% endif %}"
              data-cancellation-reason="{% if ride.cancellation_reason %}{{ ride.cancellation_reason }}{% endif %}"
            >
              View Details
            </button>
          </div>

        </div>
      {% endfor %}
    </div>

    <div class="ride-details-modal" id="rideDetailsModal" aria-hidden="true">
      <div class="ride-details-sheet" role="dialog" aria-modal="true" aria-labelledby="rideDetailsTitle">
        <div class="sheet-handle"></div>
        <div class="sheet-head">
          <div class="sheet-title" id="rideDetailsTitle">Ride Details</div>
          <button type="button" class="sheet-close" id="closeRideDetails" aria-label="Close">✕</button>
        </div>
        <div class="sheet-meta">
          <span class="sheet-booking" id="detailBookingId">#-</span>
          <span class="status-badge" id="detailStatusBadge">Unknown</span>
        </div>
        <div class="details-list">
          <div class="details-row"><span class="details-label">Driver</span><span class="details-value" id="detailDriver">-</span></div>
          <div class="details-row"><span class="details-label">Ride Type</span><span class="details-value" id="detailRideType">-</span></div>
          <div class="details-row"><span class="details-label">Fare</span><span class="details-value" id="detailFare">-</span></div>
          <div class="details-row"><span class="details-label">Date & Time</span><span class="details-value" id="detailDateTime">-</span></div>
          <div class="details-row"><span class="details-label">Pickup</span><span class="details-value" id="detailPickup">-</span></div>
          <div class="details-row"><span class="details-label">Drop</span><span class="details-value" id="detailDropoff">-</span></div>
          <div class="details-row"><span class="details-label">Distance</span><span class="details-value" id="detailDistance">-</span></div>
          <div class="details-row"><span class="details-label">Duration</span><span class="details-value" id="detailDuration">-</span></div>
          <div class="details-row"><span class="details-label">Payment Mode</span><span class="details-value" id="detailPaymentMode">-</span></div>
          <div class="details-row" id="detailCancelledByRow" style="display:none;"><span class="details-label">Cancelled By</span><span class="details-value" id="detailCancelledBy">-</span></div>
          <div class="details-row" id="detailCancellationReasonRow" style="display:none;"><span class="details-label">Cancel Reason</span><span class="details-value" id="detailCancellationReason">-</span></div>
        </div>
      </div>
    </div>

  {% else %}

    <!-- Empty state -->
    <div class="empty-state">
      <div class="empty-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
      </div>
      <div class="empty-title">No rides yet</div>
      <div class="empty-desc">You haven't booked any rides. Start your first journey with us.</div>
      <button class="btn-book">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Book a Ride
      </button>
    </div>

  {% endif %}

</div><!-- /app-shell -->

<script>
  const rideFilterPills = document.querySelectorAll('.filter-pill');
  const rideCards       = document.querySelectorAll('.ride-card');
  const ridesContainer  = document.getElementById('rides-container');
  let rideDetailsModal = document.getElementById('rideDetailsModal');
  const closeRideDetailsBtn = document.getElementById('closeRideDetails');

  if (rideDetailsModal && rideDetailsModal.parentElement !== document.body) {
    document.body.appendChild(rideDetailsModal);
  }

  function filterRides(status) {
    rideFilterPills.forEach(function(pill) {
      pill.classList.toggle('active', pill.dataset.filter === status);
    });

    rideCards.forEach(function(card) {
      const cardStatus = (card.dataset.status || '').toLowerCase();
      const isCancelledStatus = cardStatus === 'cancelled' || cardStatus === 'cancelledbypassenger' || cardStatus === 'cancelledbydriver';

      if (status === 'all' || cardStatus === status || (status === 'cancelled' && isCancelledStatus)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  }

  function setDetail(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value || '-';
  }

  function toggleDetailRow(rowId, valueId, value) {
    const row = document.getElementById(rowId);
    const val = document.getElementById(valueId);
    if (!row || !val) return;
    if (value) {
      val.textContent = value;
      row.style.display = 'flex';
    } else {
      row.style.display = 'none';
    }
  }

  function updateStatusBadge(status) {
    const badge = document.getElementById('detailStatusBadge');
    if (!badge) return;

    badge.textContent = status || 'Unknown';
    badge.className = 'status-badge';

    const lowered = (status || '').toLowerCase();
    if (lowered.includes('completed')) badge.classList.add('status-completed');
    else if (lowered.includes('pending')) badge.classList.add('status-pending');
    else if (lowered.includes('ongoing') || lowered.includes('arrived') || lowered.includes('confirmed')) {
      badge.classList.add('status-ongoing');
    } else if (lowered.includes('cancelled')) {
      badge.classList.add('status-cancelled');
    }
  }

  function openRideDetails(button) {
    const data = button.dataset;
    setDetail('detailBookingId', '#' + (data.bookingId || '-'));
    setDetail('detailDriver', data.driverName);
    setDetail('detailRideType', data.rideType);
    setDetail('detailFare', data.fare);
    setDetail('detailDateTime', data.dateTime);
    setDetail('detailPickup', data.pickup);
    setDetail('detailDropoff', data.dropoff);
    setDetail('detailDistance', data.distance);
    setDetail('detailDuration', data.duration);
    setDetail('detailPaymentMode', data.paymentMode);
    updateStatusBadge(data.status);
    toggleDetailRow('detailCancelledByRow', 'detailCancelledBy', data.cancelledBy);
    toggleDetailRow('detailCancellationReasonRow', 'detailCancellationReason', data.cancellationReason);

    if (rideDetailsModal) {
      rideDetailsModal.classList.add('is-open');
      rideDetailsModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('ride-modal-open');
    }
  }

  function closeRideDetails() {
    if (rideDetailsModal) {
      rideDetailsModal.classList.remove('is-open');
      rideDetailsModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('ride-modal-open');
    }
  }

  if (ridesContainer) {
    ridesContainer.addEventListener('click', function(event) {
      const trigger = event.target.closest('.js-view-ride-details');
      if (!trigger) return;
      openRideDetails(trigger);
    });
  }

  if (closeRideDetailsBtn) {
    closeRideDetailsBtn.addEventListener('click', closeRideDetails);
  }

  if (rideDetailsModal) {
    rideDetailsModal.addEventListener('click', function(event) {
      if (event.target === rideDetailsModal) closeRideDetails();
    });
  }

  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') closeRideDetails();
  });
</script>
